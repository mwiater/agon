# Gemini Context Cancellation Plan

This plan details the steps to implement graceful cancellation of in-flight Ollama API requests when the user quits the application.

### 1. Create and Manage the Main Context in the `chat` Command

*   **File:** `internal/cli/chat.go`
*   **Actions:**
    1.  In the `Run` function of the `chatCmd`, create a main cancellable context: `ctx, cancel := context.WithCancel(context.Background())`.
    2.  Immediately after, schedule the `cancel()` function to be called when the `Run` function exits using `defer cancel()`.
    3.  Pass the `ctx` to the `startPipelineGUI` and `startGUI` function calls.

### 2. Propagate the Context to the Pipeline UI

*   **File:** `cli/cli_pipeline.go`
*   **Actions:**
    1.  Modify the `StartPipelineGUI` function signature to accept a `context.Context` as the first argument.
    2.  Pass this context to the `initialPipelineModel` function.
    3.  Add a `ctx context.Context` field to the `pipelineModel` struct.
    4.  In `initialPipelineModel`, store the passed context in the new `ctx` field of the `pipelineModel`.

### 3. Use the Context for Pipeline Stage Requests

*   **File:** `cli/cli_pipeline.go`
*   **Actions:**
    1.  Modify the `pipelineStreamStageCmd` function signature to accept the `context.Context` from the `pipelineModel`.
    2.  In the `queueStage` function, when calling `pipelineStreamStageCmd`, pass `m.ctx`.
    3.  Inside `pipelineStreamStageCmd`, find the line: `ctx, cancel := context.WithTimeout(context.Background(), timeout)`.
    4.  Change this line to use the propagated context as the parent: `ctx, cancel := context.WithTimeout(pctx, timeout)` (where `pctx` is the name of the new context parameter).

### 4. Update the Ollama Provider Call

*   **File:** `cli/cli_pipeline.go`
*   **Actions:**
    1.  The `pipelineStreamStageCmd` function calls the provider's `Stream` method. The previous step ensures the correct, cancellable context is already being passed, so no changes are needed here. The `http.NewRequestWithContext` call within the provider will now correctly use the cancellable context.

### 5. Propagate the Context to the Multimodel UI

*   **File:** `cli/cli_multimodel.go`
*   **Actions:**
    1.  Modify the `StartMultimodelGUI` function signature to accept a `context.Context`.
    2.  Add a `ctx context.Context` field to the `multimodel` struct.
    3.  In `StartMultimodelGUI`, pass the context when creating the `multimodel`.
    4.  In `streamResponse`, when creating the request, use the model's context as the parent for the timeout context: `reqCtx, cancel := context.WithTimeout(m.ctx, m.requestTimeout)`.

### 6. Update the `chat.go` mocks for testing

*   **File:** `internal/cli/chat.go`
*   **Actions:**
    1. The test mocks for `startGUI` and `startPipelineGUI` will need to be updated to reflect the new function signatures.
